<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button (click)="cerrar()">
        <ion-icon slot="icon-only" name="close-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title>{{ tituloModal }}</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content>
  <div class="modal-content">

    <!-- Hint -->
    <div class="hint-card">
      <ion-icon [name]="iconoServicio"></ion-icon>
      <p>
        @if (tipo === 'CELULAR') {
          Registrá cuando el proveedor agregó saldo virtual a tu cuenta
        } @else {
          Registrá cuando comprás saldo virtual mediante depósito bancario
        }
      </p>
    </div>

    <!-- ── SECCIÓN BUS: saldo en máquina (paso previo) ── -->
    @if (tipo === 'BUS') {
      <div class="input-group">
        <label class="input-label">Saldo actual en la máquina</label>
        <div class="amount-wrapper" [class.filled]="saldoVirtualMaquina !== null">
          <span class="currency">$</span>
          <input
            type="number"
            inputmode="decimal"
            placeholder="0.00"
            [(ngModel)]="saldoVirtualMaquina"
            appCurrencyInput
            appNumbersOnly
            autofocus>
        </div>
        <span class="helper-text">Lo que muestra la máquina de bus ahora mismo</span>
      </div>

      <!-- Info de disponibilidad (cuando ingresó saldo máquina) -->
      @if (maquinaIngresada) {
        <div class="disponible-card">
          <div class="disponible-row">
            <span>Caja BUS acumulada</span>
            <span>${{ saldoCajaBus | number:'1.2-2' }}</span>
          </div>
          <div class="disponible-row">
            <span>Ventas del día (sin cerrar)</span>
            <span class="valor-ventas">+${{ ventaBusCalculada | number:'1.2-2' }}</span>
          </div>
          <div class="disponible-row total">
            <span>Disponible para depositar</span>
            <span class="valor-total">${{ disponibleParaDepositar | number:'1.2-2' }}</span>
          </div>
        </div>
      }
    }

    <!-- Input monto a depositar / monto virtual -->
    <div class="input-group">
      <label class="input-label">{{ labelMonto }}</label>
      <div class="amount-wrapper" [class.filled]="montoVirtual">
        <span class="currency">$</span>
        <input
          type="number"
          inputmode="decimal"
          placeholder="0.00"
          [(ngModel)]="montoVirtual"
          appCurrencyInput
          appNumbersOnly
          [autofocus]="tipo === 'CELULAR'">
      </div>
    </div>

    <!-- Botones -->
    <div class="modal-actions">
      <button
        class="secondary-btn"
        (click)="cerrar()">
        Cancelar
      </button>
      <button
        class="primary-btn"
        [disabled]="!montoVirtual || montoVirtual <= 0 || saldoBusInsuficiente"
        (click)="confirmar()">
        <ion-icon name="add-circle-outline"></ion-icon>
        @if (tipo === 'CELULAR') {
          Registrar deuda
        } @else {
          Confirmar depósito
        }
      </button>
    </div>

    <!-- Cálculos (solo CELULAR) -->
    @if (mostrarCalculos) {
      <div class="calculo-preview">
        <div class="calculo-row">
          <span>Deuda a pagar al proveedor</span>
          <span class="calculo-danger">${{ montoAPagar | number:'1.2-2' }}</span>
        </div>
        <div class="calculo-row">
          <span>Ganancia ({{ comisionPct }}%) — se transfiere al pagar</span>
          <span class="calculo-success">${{ ganancia | number:'1.2-2' }}</span>
        </div>
      </div>
    }

    <!-- Preview CAJA_BUS después del depósito (solo BUS con monto ingresado) -->
    @if (tipo === 'BUS' && montoVirtual && montoVirtual > 0) {
      @if (!saldoBusInsuficiente) {
        <div class="calculo-preview">
          <div class="calculo-row">
            <span>CAJA BUS después del depósito</span>
            <span class="calculo-success">
              ${{ saldoBusDespues | number:'1.2-2' }}
              <ion-icon name="checkmark-circle-outline" color="success"></ion-icon>
            </span>
          </div>
        </div>
      } @else {
        <div class="alerta-saldo">
          <ion-icon name="alert-circle-outline" color="danger"></ion-icon>
          <div>
            <strong>Efectivo insuficiente</strong>
            <p>El monto supera el efectivo disponible (${{ disponibleParaDepositar | number:'1.2-2' }})</p>
          </div>
        </div>
      }
    }

  </div>
</ion-content>
