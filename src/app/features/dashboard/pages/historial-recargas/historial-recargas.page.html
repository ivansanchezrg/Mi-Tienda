<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-menu-button></ion-menu-button>
    </ion-buttons>
    <ion-title>Recargas</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content>
  <ion-refresher slot="fixed" (ionRefresh)="handleRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <!-- Barra de filtros -->
  <div class="filter-bar">
    <span class="filter-label">Historial</span>
    <div class="filter-tabs">
      @for (f of filtros; track f.value) {
        <button
          class="filter-tab"
          [class.active]="filtroActual === f.value"
          (click)="cambiarFiltro(f.value)">
          {{ f.label }}
        </button>
      }
    </div>
  </div>

  <!-- Estados -->
  @if (loading && items.length === 0) {
    <div class="empty-state">
      <ion-spinner name="crescent"></ion-spinner>
      <p>Cargando recargas...</p>
    </div>
  }

  @if (!loading && items.length === 0) {
    <div class="empty-state">
      <ion-icon name="list-outline"></ion-icon>
      <p>No hay registros de recargas</p>
    </div>
  }

  <!-- Lista agrupada por fecha -->
  @if (itemsAgrupados.length > 0) {
    @for (grupo of itemsAgrupados; track grupo.fecha) {

      <!-- Encabezado de fecha -->
      <div class="date-header">
        <span class="date-text">{{ grupo.fechaDisplay }}</span>
      </div>

      <!-- Card del grupo -->
      <ion-card class="operations-card">
        @for (item of grupo.items; track item.id; let last = $last) {

          @if (item.tipo === 'CARGA_VIRTUAL') {
            <!-- ── RECARGA DEL PROVEEDOR ── -->
            <div class="op-row">
              <div class="op-icon" data-type="virtual">
                <ion-icon name="cloud-download-outline"></ion-icon>
              </div>

              <div class="op-details">
                <div class="op-title-row">
                  <span class="op-title">{{ item.servicio }}</span>
                  <span class="badge-virtual">Recarga proveedor</span>
                </div>

                <div class="op-footer">
                  <span class="op-time">{{ formatearHora(item.created_at) }}</span>
                  @if (!item.pagado) {
                    <span class="badge-deuda">Pendiente pago</span>
                  }
                </div>
              </div>

              <div class="op-right">
                <span class="op-amount" data-type="virtual">
                  +${{ item.monto_virtual | number:'1.2-2' }}
                </span>
              </div>
            </div>

          } @else {
            <!-- ── CIERRE DE TURNO ── -->
            <div class="op-row">
              <div class="op-icon" [attr.data-type]="getColorServicio(item.servicio)">
                <ion-icon [name]="getIconoServicio(item.servicio)"></ion-icon>
              </div>

              <div class="op-details">
                <div class="op-title-row">
                  <span class="op-title">{{ item.servicio }}</span>
                </div>

                <div class="recarga-info">
                  <span class="info-item">Anterior: ${{ item.saldo_anterior | number:'1.2-2' }}</span>
                  <span class="dot">·</span>
                  <span class="info-item">Actual: ${{ item.saldo_actual | number:'1.2-2' }}</span>
                </div>

                <div class="op-footer">
                  <span class="op-time">{{ formatearHora(item.created_at) }}</span>
                </div>
              </div>

              <div class="op-right">
                <span class="op-amount" [attr.data-type]="(item.venta_dia ?? 0) >= 0 ? 'success' : 'danger'">
                  ${{ item.venta_dia | number:'1.2-2' }}
                </span>
              </div>
            </div>
          }

          @if (!last) {
            <div class="op-divider"></div>
          }
        }
      </ion-card>
    }
  }
</ion-content>
