<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button (click)="volver()">
        <ion-icon slot="icon-only" name="arrow-back-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title>Cierre Diario</ion-title>
  </ion-toolbar>
  <ion-progress-bar [value]="pasoActual / totalPasos"></ion-progress-bar>
</ion-header>

<ion-content [appScrollReset]="pasoActual">
  <div class="wizard-container">
    <div class="step-indicator">
      <span>Paso {{ pasoActual }} de {{ totalPasos }}</span>
    </div>

    <!-- PASO 1: Ingresar Saldos -->
    @if (pasoActual === 1) {
      <div class="paso">
        <div class="paso-header">
          <h2>Ingresar Saldos</h2>
          <p>Registra los montos finales del d√≠a</p>
        </div>

        <form [formGroup]="cierreForm">
          <ion-list class="input-list">
            <!-- Saldo Virtual Celular -->
            <ion-item class="input-item">
              <ion-icon slot="start" name="phone-portrait-outline" class="item-icon celular"></ion-icon>
              <ion-label position="stacked">
                <strong>Saldo Virtual Celular</strong>
                <ion-note>Consulta el saldo en el tel√©fono</ion-note>
              </ion-label>
              <div class="input-wrapper">
                <span class="currency-prefix">$</span>
                <ion-input
                  appNumbersOnly
                  appCurrencyInput
                  formControlName="saldoVirtualCelularFinal"
                  type="text"
                  inputmode="decimal"
                  placeholder="0.00">
                </ion-input>
              </div>
            </ion-item>

            @if (ventaCelular < 0 && cierreForm.get('saldoVirtualCelularFinal')?.value) {
              <div class="alerta-simple danger">
                <ion-icon name="alert-circle-outline" color="danger"></ion-icon>
                <div>
                  <p><strong>‚ö†Ô∏è Venta negativa: {{ ventaCelular | currency:'USD':'symbol-narrow':'1.2-2' }}</strong></p>
                  <p>Registr√° la recarga del proveedor en <strong>Recargas Virtuales</strong> antes de cerrar.</p>
                </div>
              </div>
            }

            <!-- Saldo Virtual Bus -->
            <ion-item class="input-item">
              <ion-icon slot="start" name="bus-outline" class="item-icon bus"></ion-icon>
              <ion-label position="stacked">
                <strong>Saldo Virtual Bus</strong>
                <ion-note>Consulta el saldo en la m√°quina</ion-note>
              </ion-label>
              <div class="input-wrapper">
                <span class="currency-prefix">$</span>
                <ion-input
                  appNumbersOnly
                  appCurrencyInput
                  formControlName="saldoVirtualBusFinal"
                  type="text"
                  inputmode="decimal"
                  placeholder="0.00">
                </ion-input>
              </div>
            </ion-item>

            @if (ventaBus < 0 && cierreForm.get('saldoVirtualBusFinal')?.value) {
              <div class="alerta-simple danger">
                <ion-icon name="alert-circle-outline" color="danger"></ion-icon>
                <div>
                  <p><strong>‚ö†Ô∏è Venta negativa: {{ ventaBus | currency:'USD':'symbol-narrow':'1.2-2' }}</strong></p>
                  <p>Registr√° la compra de saldo virtual en <strong>Recargas Virtuales</strong> antes de cerrar.</p>
                </div>
              </div>
            }

            <!-- Efectivo Total Recaudado -->
            <ion-item class="input-item">
              <ion-icon slot="start" name="wallet-outline" class="item-icon efectivo"></ion-icon>
              <ion-label position="stacked">
                <strong>Efectivo Total Recaudado</strong>
                <ion-note>Suma de todo el efectivo del d√≠a</ion-note>
              </ion-label>
              <div class="input-wrapper">
                <span class="currency-prefix">$</span>
                <ion-input
                  appNumbersOnly
                  appCurrencyInput
                  formControlName="efectivoTotalRecaudado"
                  type="text"
                  inputmode="decimal"
                  placeholder="0.00">
                </ion-input>
              </div>
            </ion-item>
          </ion-list>
        </form>

        <div class="paso-actions">
          <ion-button expand="block" size="large" (click)="siguientePaso()" [disabled]="cierreForm.invalid || hayVentaNegativa">
            Siguiente
            <ion-icon slot="end" name="arrow-forward-outline"></ion-icon>
          </ion-button>
        </div>
      </div>
    }

    <!-- PASO 2: Verificaci√≥n -->
    @if (pasoActual === 2) {
      <div class="paso">
        <div class="paso-header">
          <h2>Verificaci√≥n Final</h2>
          <p>Revisa los c√°lculos antes de confirmar</p>
        </div>

        <!-- Ventas del D√≠a -->
        <ion-card class="resumen-card">
          <ion-card-header>
            <ion-card-title>
              <ion-icon name="trending-up-outline"></ion-icon>
              Ventas del D√≠a
            </ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <!-- Secci√≥n: Efectivo de Caja -->
            <div class="seccion-titulo">
              <strong>Efectivo de Caja</strong>
            </div>
            <div class="venta-item">
              <div class="venta-header">
                <ion-icon name="cash-outline" class="venta-icon efectivo"></ion-icon>
                <span class="venta-nombre">Efectivo Recaudado</span>
              </div>
              <div class="venta-detalle">
                <span class="venta-monto">{{ efectivoRecaudado | currency:'USD':'symbol-narrow':'1.2-2' }}</span>
              </div>
            </div>

            <!-- Desglose del efectivo -->
            <div class="desglose-efectivo">
              <div class="desglose-item">
                <span class="desglose-label">Fondo Fijo (caja f√≠sica)</span>
                <span class="desglose-valor resta">-{{ fondoFijo | currency:'USD':'symbol-narrow':'1.2-2' }}</span>
              </div>
              <div class="desglose-item">
                <span class="desglose-label">
                  Caja Chica
                  @if (hayDeficitCajaChica) {
                    <span class="deficit-badge">d√©ficit</span>
                  }
                </span>
                <span class="desglose-valor resta" [class.deficit]="hayDeficitCajaChica">
                  -{{ transferenciaEfectivaCajaChica | currency:'USD':'symbol-narrow':'1.2-2' }}
                </span>
              </div>
              <div class="desglose-item resultado">
                <span class="desglose-label">
                  <ion-icon name="checkmark-outline" class="desglose-icon"></ion-icon>
                  A Caja Principal
                </span>
                <span class="desglose-valor destacado">{{ dineroADepositar | currency:'USD':'symbol-narrow':'1.2-2' }}</span>
              </div>
            </div>

            
            <!-- Secci√≥n: Recargas -->
            <div class="seccion-titulo">
              <strong>Efectivo Recargas</strong>
            </div>
            <div class="venta-item">
              <div class="venta-header">
                <ion-icon name="phone-portrait-outline" class="venta-icon celular"></ion-icon>
                <span class="venta-nombre">Celular</span>
              </div>
              <div class="venta-detalle">
                <span class="venta-monto">{{ ventaCelular | currency:'USD':'symbol-narrow':'1.2-2' }}</span>
              </div>
            </div>

            <div class="venta-item">
              <div class="venta-header">
                <ion-icon name="bus-outline" class="venta-icon bus"></ion-icon>
                <span class="venta-nombre">Bus</span>
              </div>
              <div class="venta-detalle">
                <span class="venta-monto">{{ ventaBus | currency:'USD':'symbol-narrow':'1.2-2' }}</span>
              </div>
            </div>
          </ion-card-content>
        </ion-card>

        <!-- Verificaci√≥n de Cajas -->
        <ion-card class="verificacion-card">
          <ion-card-header>
            <ion-card-title>
              <ion-icon name="calculator-outline"></ion-icon>
              Verificaci√≥n de Cajas
            </ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <div class="caja-verificacion">
              <div class="caja-nombre">
                <ion-icon name="cash-outline" class="caja-icon caja"></ion-icon>
                <strong>CAJA</strong>
              </div>
              <div class="caja-calculo">
                <span class="saldo">{{ saldoAnteriorCaja | currency:'USD':'symbol-narrow':'1.2-2' }}</span>
                <span class="operador">+</span>
                <span class="operacion">{{ dineroADepositar | currency:'USD':'symbol-narrow':'1.2-2' }}</span>
                <span class="operador">=</span>
                <span class="resultado">{{ saldoFinalCaja | currency:'USD':'symbol-narrow':'1.2-2' }}</span>
              </div>
            </div>

            <div class="caja-verificacion" [class.con-deficit]="hayDeficitCajaChica">
              <div class="caja-nombre">
                <ion-icon name="wallet-outline" class="caja-icon caja-chica"></ion-icon>
                <strong>CAJA CHICA</strong>
                @if (hayDeficitCajaChica) {
                  <span class="deficit-badge">-{{ deficitCajaChica | currency:'USD':'symbol-narrow':'1.2-2' }} pendiente</span>
                }
              </div>
              <div class="caja-calculo">
                <span class="saldo">{{ saldoAnteriorCajaChica | currency:'USD':'symbol-narrow':'1.2-2' }}</span>
                <span class="operador">+</span>
                <span class="operacion">{{ transferenciaEfectivaCajaChica | currency:'USD':'symbol-narrow':'1.2-2' }}</span>
                <span class="operador">=</span>
                <span class="resultado">{{ saldoFinalCajaChica | currency:'USD':'symbol-narrow':'1.2-2' }}</span>
              </div>
            </div>

            <div class="caja-verificacion">
              <div class="caja-nombre">
                <ion-icon name="phone-portrait-outline" class="caja-icon celular"></ion-icon>
                <strong>CELULAR</strong>
              </div>
              <div class="caja-calculo">
                <span class="saldo">{{ saldoAnteriorCajaCelular | currency:'USD':'symbol-narrow':'1.2-2' }}</span>
                <span class="operador">+</span>
                <span class="operacion">{{ ventaCelular | currency:'USD':'symbol-narrow':'1.2-2' }}</span>
                <span class="operador">=</span>
                <span class="resultado">{{ saldoFinalCajaCelular | currency:'USD':'symbol-narrow':'1.2-2' }}</span>
              </div>
            </div>

            <div class="caja-verificacion">
              <div class="caja-nombre">
                <ion-icon name="bus-outline" class="caja-icon bus"></ion-icon>
                <strong>BUS</strong>
              </div>
              <div class="caja-calculo">
                <span class="saldo">{{ saldoAnteriorCajaBus | currency:'USD':'symbol-narrow':'1.2-2' }}</span>
                <span class="operador">+</span>
                <span class="operacion">{{ ventaBus | currency:'USD':'symbol-narrow':'1.2-2' }}</span>
                <span class="operador">=</span>
                <span class="resultado">{{ saldoFinalCajaBus | currency:'USD':'symbol-narrow':'1.2-2' }}</span>
              </div>
            </div>
          </ion-card-content>
        </ion-card>

        <!-- Acciones f√≠sicas ‚Äî CASO NORMAL -->
        @if (!hayDeficitCajaChica) {
          <div class="alerta-simple info">
            <ion-icon name="information-circle-outline" color="primary"></ion-icon>
            <div>
              <p><strong>Acciones f√≠sicas a realizar:</strong></p>
              <ul>
                <li>Coloca <strong>{{ transferenciaEfectivaCajaChica | currency:'USD':'symbol-narrow':'1.2-2' }}</strong> en la funda de CAJA CHICA</li>
                @if (dineroADepositar > 0) {
                  <li>Coloca <strong>{{ dineroADepositar | currency:'USD':'symbol-narrow':'1.2-2' }}</strong> en la funda de CAJA PRINCIPAL</li>
                }
                <li>Deja <strong>{{ fondoFijo | currency:'USD':'symbol-narrow':'1.2-2' }}</strong> en la caja f√≠sica como fondo para ma√±ana</li>
              </ul>
            </div>
          </div>
        }

        <!-- Acciones f√≠sicas ‚Äî D√âFICIT PARCIAL (hay fondo pero no alcanza para Caja Chica) -->
        @if (hayDeficitCajaChica && !hayDeficitTotal) {
          <div class="alerta-simple warning">
            <ion-icon name="alert-circle-outline" color="warning"></ion-icon>
            <div>
              <p><strong>‚ö†Ô∏è Efectivo insuficiente para Caja Chica</strong></p>
              <ul>
                <li>Caja Chica <strong>no recibe nada</strong> este turno (faltaron {{ deficitCajaChica | currency:'USD':'symbol-narrow':'1.2-2' }})</li>
                @if (dineroADepositar > 0) {
                  <li>Coloca <strong>{{ dineroADepositar | currency:'USD':'symbol-narrow':'1.2-2' }}</strong> en la funda de CAJA PRINCIPAL</li>
                }
                <li>Deja <strong>{{ fondoFijo | currency:'USD':'symbol-narrow':'1.2-2' }}</strong> en la caja f√≠sica como fondo para ma√±ana</li>
              </ul>
              <p class="deficit-nota">El siguiente turno deber√° reponer <strong>{{ deficitCajaChica | currency:'USD':'symbol-narrow':'1.2-2' }}</strong> a Caja Chica desde Caja Principal.</p>
            </div>
          </div>
        }

        <!-- Acciones f√≠sicas ‚Äî D√âFICIT TOTAL (ni el fondo alcanza) -->
        @if (hayDeficitTotal) {
          <div class="alerta-simple danger">
            <ion-icon name="alert-circle-outline" color="danger"></ion-icon>
            <div>
              <p><strong>üö® Efectivo insuficiente ‚Äî Fondo incompleto</strong></p>
              <ul>
                <li>Caja Chica <strong>no recibe nada</strong> este turno</li>
                <li>Caja Principal <strong>no recibe nada</strong> este turno</li>
                <li>Deja los <strong>{{ efectivoRecaudado | currency:'USD':'symbol-narrow':'1.2-2' }}</strong> disponibles en la caja f√≠sica</li>
              </ul>
              <p class="deficit-nota">El siguiente turno deber√° tomar <strong>{{ fondoFijo | currency:'USD':'symbol-narrow':'1.2-2' }}</strong> de Caja Principal para completar el fondo y reponer <strong>{{ deficitCajaChica | currency:'USD':'symbol-narrow':'1.2-2' }}</strong> a Caja Chica.</p>
            </div>
          </div>
        }

        <div class="alerta-simple warning">
          <ion-icon name="alert-circle-outline" color="warning"></ion-icon>
          <p>Verifica el efectivo f√≠sico antes de confirmar el cierre.</p>
        </div>

        <!-- Observaciones -->
        <ion-card class="observaciones-card" [formGroup]="cierreForm">
          <ion-card-header>
            <ion-card-title>Observaciones (Opcional)</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <ion-item class="observaciones-item" lines="none">
              <ion-textarea
                formControlName="observaciones"
                placeholder="Agrega notas sobre el cierre del d√≠a..."
                rows="3"
                maxlength="500">
              </ion-textarea>
            </ion-item>
          </ion-card-content>
        </ion-card>

        <div class="paso-actions">
          <ion-button expand="block" fill="outline" (click)="pasoAnterior()">
            <ion-icon slot="start" name="arrow-back-outline"></ion-icon>
            Atr√°s
          </ion-button>
          <ion-button expand="block" color="success" (click)="confirmarCierre()">
            <ion-icon slot="start" name="checkmark-circle-outline"></ion-icon>
            Confirmar Cierre
          </ion-button>
        </div>
      </div>
    }
  </div>
</ion-content>
